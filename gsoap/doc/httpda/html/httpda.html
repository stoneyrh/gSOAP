<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>gSOAP HTTP Digest Authentication: The http_da plugin for clients and stand-alone services</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.4 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">gSOAP HTTP Digest Authentication&#160;<span id="projectnumber">Stable release</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">The http_da plugin for clients and stand-alone services </div>  </div>
</div>
<div class="contents">
<div class="textblock"><p>Additional build steps required:</p>
<ul>
<li>Compile all sources with -DWITH_OPENSSL</li>
<li>Link libgsoapssl (libgsoapssl++), or use the lib's stdsoap2.c/.cpp source</li>
<li>Compile and link with <a class="el" href="httpda_8c.html">plugin/httpda.c</a>, <a class="el" href="md5evp_8c.html">plugin/md5evp.c</a>, and <a class="el" href="threads_8c.html">plugin/threads.c</a></li>
</ul>
<h2><a class="anchor" id="httpda_1"></a>
Client-Side Usage</h2>
<p>HTTP Basic Authentication is the default authentication supported by gSOAP. The credentials for client-side use age set with:</p>
<div class="fragment"><pre class="fragment">soap.userid = <span class="stringliteral">&quot;&lt;userid&gt;&quot;</span>;
soap.passed = <span class="stringliteral">&quot;&lt;passwd&gt;&quot;</span>;
<span class="keywordflow">if</span> (soap_call_ns__method(&amp;soap, ...))
  ... <span class="comment">// error</span>
</pre></div><p>HTTP Basic Authentication should never be used over plain HTTP, because the user ID and password are sent in the clear. It is safe(r) to use over HTTPS, because the HTTP headers and body are encrypted.</p>
<p>The better alternative is to use HTTP Digest Authentication, which uses the digest (hash value) of the credentials and avoids a plain-text password exchange.</p>
<p>To use HTTP Digest Authentication with gSOAP, register the http_da plugin:</p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include &quot;<a class="code" href="httpda_8h.html">httpda.h</a>&quot;</span>
soap_register_plugin(&amp;soap, <a class="code" href="httpda_8h.html#a193bd879015f573a6a6de4b3f03f70cc">http_da</a>);
</pre></div><p>To make a client-side service call:</p>
<div class="fragment"><pre class="fragment"><span class="keyword">struct </span><a class="code" href="structhttp__da__info.html" title="Used to save and restore credentials for client-side multiple invocations to the same authenticated e...">http_da_info</a> info;
<a class="code" href="httpda_8h.html#a4d48599051c3ae3dc61e56bd97deba7a">http_da_save</a>(&amp;soap, &amp;info, <span class="stringliteral">&quot;&lt;authrealm&gt;&quot;</span>, <span class="stringliteral">&quot;&lt;userid&gt;&quot;</span>, <span class="stringliteral">&quot;&lt;passwd&gt;&quot;</span>);
<span class="keywordflow">if</span> (soap_call_ns__method(&amp;soap, ...))
  ... <span class="comment">// error</span>
</pre></div><p>The "&lt;authrealm&gt;" is a string that is associated with the server's realm. It can be obtained after an unsuccessful non-authenticated call:</p>
<div class="fragment"><pre class="fragment"><span class="keywordflow">if</span> (soap_call_ns__method(&amp;soap, ...))
{
  <span class="keywordflow">if</span> (soap.error == 401) <span class="comment">// HTTP authentication is required</span>
  {
    <span class="keyword">const</span> <span class="keywordtype">char</span> *realm = soap.authrealm;
    ...
  }
  <span class="keywordflow">else</span>
    ... <span class="comment">// error</span>
}
</pre></div><p>Before a second call is made to the same endpoint that requires authentication, you must restore the authentication state and then finally release it:</p>
<div class="fragment"><pre class="fragment"><span class="keyword">struct </span><a class="code" href="structhttp__da__info.html" title="Used to save and restore credentials for client-side multiple invocations to the same authenticated e...">http_da_info</a> info;

<a class="code" href="httpda_8h.html#a4d48599051c3ae3dc61e56bd97deba7a">http_da_save</a>(&amp;soap, &amp;info, <span class="stringliteral">&quot;&lt;authrealm&gt;&quot;</span>, <span class="stringliteral">&quot;&lt;userid&gt;&quot;</span>, <span class="stringliteral">&quot;&lt;passwd&gt;&quot;</span>);
<span class="keywordflow">if</span> (soap_call_ns__method(&amp;soap, ...))
  ... <span class="comment">// error</span>

<a class="code" href="httpda_8h.html#a6bcb428607280dbe2b0dcc63742cda60">http_da_restore</a>(&amp;soap, &amp;info);
<span class="keywordflow">if</span> (soap_call_ns__method(&amp;soap, ...))
  ... <span class="comment">// error</span>

soap_destroy(&amp;soap); <span class="comment">// okay to dealloc data</span>
soap_end(&amp;soap);     <span class="comment">// okay to dealloc data</span>

<a class="code" href="httpda_8h.html#a6bcb428607280dbe2b0dcc63742cda60">http_da_restore</a>(&amp;soap, &amp;info);
<span class="keywordflow">if</span> (soap_call_ns__method(&amp;soap, ...))
  ... <span class="comment">// error</span>

<a class="code" href="httpda_8h.html#a25230ec921c71e515fc4280991af6533">http_da_release</a>(&amp;soap, &amp;info);
soap_destroy(&amp;soap);
soap_end(&amp;soap);
soap_done(&amp;soap);
</pre></div><p>For HTTP proxies requiring HTTP Digest Authenticaiton, use the 'proxy' functions:</p>
<div class="fragment"><pre class="fragment"><span class="keyword">struct </span><a class="code" href="structhttp__da__info.html" title="Used to save and restore credentials for client-side multiple invocations to the same authenticated e...">http_da_info</a> info;

<a class="code" href="httpda_8h.html#a69acb5bfe6dfbbbeb69f0d991fcf6f0f">http_da_proxy_save</a>(&amp;soap, &amp;info, <span class="stringliteral">&quot;&lt;authrealm&gt;&quot;</span>, <span class="stringliteral">&quot;&lt;userid&gt;&quot;</span>, <span class="stringliteral">&quot;&lt;passwd&gt;&quot;</span>);
<span class="keywordflow">if</span> (soap_call_ns__method(&amp;soap, ...))
  ... <span class="comment">// error</span>

<a class="code" href="httpda_8h.html#a508dfa526e88a5c3696c9a6aa5bc0800">http_da_proxy_restore</a>(&amp;soap, &amp;info);
<span class="keywordflow">if</span> (soap_call_ns__method(&amp;soap, ...))
  ... <span class="comment">// error</span>

soap_destroy(&amp;soap); <span class="comment">// okay to dealloc data</span>
soap_end(&amp;soap);     <span class="comment">// okay to dealloc data</span>

<a class="code" href="httpda_8h.html#a508dfa526e88a5c3696c9a6aa5bc0800">http_da_proxy_restore</a>(&amp;soap, &amp;info);
<span class="keywordflow">if</span> (soap_call_ns__method(&amp;soap, ...))
  ... <span class="comment">// error</span>

<a class="code" href="httpda_8h.html#a130a4e7a9e318c649577c3ae2bc0665d">http_da_proxy_release</a>(&amp;soap, &amp;info);
soap_destroy(&amp;soap);
soap_end(&amp;soap);
soap_done(&amp;soap);
</pre></div><h2><a class="anchor" id="httpda_2"></a>
Client Example</h2>
<p>A client authenticating against a server:</p>
<div class="fragment"><pre class="fragment">soap_register_plugin(&amp;soap, <a class="code" href="httpda_8h.html#a193bd879015f573a6a6de4b3f03f70cc">http_da</a>);
<span class="comment">// try calling without authenticating</span>
<span class="keywordflow">if</span> (soap_call_ns__method(&amp;soap, ...))
{
  <span class="keywordflow">if</span> (soap.error == 401) <span class="comment">// HTTP authentication is required</span>
  {
    <span class="keywordflow">if</span> (!strcmp(soap.authrealm, <a class="code" href="structhttp__da__info.html#a6a2f59964d40689e21165afe21a5bf17">authrealm</a>)) <span class="comment">// check authentication realm</span>
    {
      <span class="keyword">struct </span><a class="code" href="structhttp__da__info.html" title="Used to save and restore credentials for client-side multiple invocations to the same authenticated e...">http_da_info</a> info; <span class="comment">// to store userid and passwd</span>
      <a class="code" href="httpda_8h.html#a4d48599051c3ae3dc61e56bd97deba7a">http_da_save</a>(&amp;soap, &amp;info, <a class="code" href="structhttp__da__info.html#a6a2f59964d40689e21165afe21a5bf17">authrealm</a>, <a class="code" href="structhttp__da__info.html#a9d713755e3c8a2f2e1754753629f7b51">userid</a>, <a class="code" href="structhttp__da__info.html#aefb8c737836359bb2983f5f88fd52adf">passwd</a>);
      <span class="comment">// call again, now with credentials</span>
      <span class="keywordflow">if</span> (soap_call_ns__method(&amp;soap, ...) == SOAP_OK)
      {
        ... <span class="comment">// process response data</span>
        soap_end(&amp;soap);
        ... <span class="comment">// userid and passwd were deallocated (!)</span>
        <a class="code" href="httpda_8h.html#a6bcb428607280dbe2b0dcc63742cda60">http_da_restore</a>(&amp;soap, &amp;info); <span class="comment">// get userid and passwd after soap_end()</span>
        <span class="keywordflow">if</span> (!soap_call_ns__method(&amp;soap, ...) == SOAP_OK)
          ... <span class="comment">// error</span>
        <a class="code" href="httpda_8h.html#a25230ec921c71e515fc4280991af6533">http_da_release</a>(&amp;soap, &amp;info); <span class="comment">// free data and remove userid and passwd</span>
</pre></div><p>A client authenticating against a proxy:</p>
<div class="fragment"><pre class="fragment">soap_register_plugin(&amp;soap, <a class="code" href="httpda_8h.html#a193bd879015f573a6a6de4b3f03f70cc">http_da</a>);
<span class="comment">// try calling without authenticating</span>
<span class="keywordflow">if</span> (soap_call_ns__method(&amp;soap, ...))
{
  <span class="keywordflow">if</span> (soap.error == 407) <span class="comment">// HTTP authentication is required</span>
  {
    <span class="keywordflow">if</span> (!strcmp(soap.authrealm, <a class="code" href="structhttp__da__info.html#a6a2f59964d40689e21165afe21a5bf17">authrealm</a>)) <span class="comment">// check authentication realm</span>
    {
      <span class="keyword">struct </span><a class="code" href="structhttp__da__info.html" title="Used to save and restore credentials for client-side multiple invocations to the same authenticated e...">http_da_info</a> info; <span class="comment">// to store userid and passwd</span>
      <a class="code" href="httpda_8h.html#a69acb5bfe6dfbbbeb69f0d991fcf6f0f">http_da_proxy_save</a>(&amp;soap, &amp;info, <a class="code" href="structhttp__da__info.html#a6a2f59964d40689e21165afe21a5bf17">authrealm</a>, <a class="code" href="structhttp__da__info.html#a9d713755e3c8a2f2e1754753629f7b51">userid</a>, <a class="code" href="structhttp__da__info.html#aefb8c737836359bb2983f5f88fd52adf">passwd</a>);
      <span class="comment">// call again, now with credentials</span>
      <span class="keywordflow">if</span> (soap_call_ns__method(&amp;soap, ...) == SOAP_OK)
      {
        ... <span class="comment">// process response data</span>
        soap_end(&amp;soap);
        ... <span class="comment">// userid and passwd were deallocated (!)</span>
        <a class="code" href="httpda_8h.html#a508dfa526e88a5c3696c9a6aa5bc0800">http_da_proxy_restore</a>(&amp;soap, &amp;info); <span class="comment">// get userid and passwd after soap_end()</span>
        <span class="keywordflow">if</span> (!soap_call_ns__method(&amp;soap, ...) == SOAP_OK)
          ... <span class="comment">// error</span>
        <a class="code" href="httpda_8h.html#a130a4e7a9e318c649577c3ae2bc0665d">http_da_proxy_release</a>(&amp;soap, &amp;info); <span class="comment">// free data and remove userid and passwd</span>
</pre></div><h2><a class="anchor" id="httpda_3"></a>
Server-Side Usage</h2>
<p>Server-side HTTP Basic Authentication can be enforced by simply checking the soap.userid and soap.passwd values in a service method that requires client authentication:</p>
<div class="fragment"><pre class="fragment">soap_register_plugin(&amp;soap, <a class="code" href="httpda_8h.html#a193bd879015f573a6a6de4b3f03f70cc">http_da</a>);
...
soap_serve(&amp;soap);
...
int ns__method(<span class="keyword">struct</span> soap *soap, ...)
{
  <span class="keywordflow">if</span> (!soap-&gt;userid || !soap-&gt;passwd || strcmp(soap-&gt;userid, <span class="stringliteral">&quot;&lt;userid&gt;&quot;</span>) || strcmp(soap-&gt;passwd, <span class="stringliteral">&quot;&lt;passwd&gt;&quot;</span>))
    <span class="keywordflow">return</span> 401; <span class="comment">// HTTP authentication required</span>
  ...
}
</pre></div><p>HTTP Digest Authentication is verified differently:</p>
<div class="fragment"><pre class="fragment">soap_register_plugin(&amp;soap, <a class="code" href="httpda_8h.html#a193bd879015f573a6a6de4b3f03f70cc">http_da</a>);
...
soap_serve(&amp;soap);
...
int ns__method(<span class="keyword">struct</span> soap *soap, ...)
{
  <span class="keywordflow">if</span> (soap-&gt;authrealm &amp;&amp; soap-&gt;userid)
  {
    <a class="code" href="structhttp__da__info.html#aefb8c737836359bb2983f5f88fd52adf">passwd</a> = ... <span class="comment">// database lookup on userid and authrealm to find passwd</span>
    <span class="keywordflow">if</span> (!strcmp(soap-&gt;authrealm, <a class="code" href="structhttp__da__info.html#a6a2f59964d40689e21165afe21a5bf17">authrealm</a>) &amp;&amp; !strcmp(soap-&gt;userid, <a class="code" href="structhttp__da__info.html#a9d713755e3c8a2f2e1754753629f7b51">userid</a>))
    { 
      <span class="keywordflow">if</span> (!<a class="code" href="httpda_8h.html#a4ae547984e266ed9d9f90f79aac1ec66">http_da_verify_post</a>(soap, <a class="code" href="structhttp__da__info.html#aefb8c737836359bb2983f5f88fd52adf">passwd</a>)) <span class="comment">// HTTP POST DA verification</span>
      {
        ... <span class="comment">// process request and produce response</span>
        <span class="keywordflow">return</span> SOAP_OK;
      }
    }
  }
  soap-&gt;authrealm = <a class="code" href="structhttp__da__info.html#a6a2f59964d40689e21165afe21a5bf17">authrealm</a>; <span class="comment">// realm to send to client</span>
  <span class="keywordflow">return</span> 401; <span class="comment">// Not authorized, challenge with digest authentication</span>
</pre></div><p>The <a class="el" href="httpda_8h.html#a4ae547984e266ed9d9f90f79aac1ec66">http_da_verify_post()</a> function checks the HTTP POST credentials. To verify an HTTP GET operation, use <a class="el" href="httpda_8h.html#af3913916c8d73131adb9adffa1fa786d">http_da_verify_get()</a>.</p>
<h2><a class="anchor" id="httpda_4"></a>
Server Example</h2>
<div class="fragment"><pre class="fragment">soap_register_plugin(&amp;soap, <a class="code" href="httpda_8h.html#a193bd879015f573a6a6de4b3f03f70cc">http_da</a>);
...
soap_serve(&amp;soap);
...
int ns__method(<span class="keyword">struct</span> soap *soap, ...)
{
  <span class="keywordflow">if</span> (soap-&gt;userid &amp;&amp; soap-&gt;passwd) <span class="comment">// Basic authentication</span>
  {
    <span class="keywordflow">if</span> (!strcmp(soap-&gt;userid, <a class="code" href="structhttp__da__info.html#a9d713755e3c8a2f2e1754753629f7b51">userid</a>) &amp;&amp; !strcmp(soap-&gt;passwd, <a class="code" href="structhttp__da__info.html#aefb8c737836359bb2983f5f88fd52adf">passwd</a>))
    {
      ... <span class="comment">// can also check soap-&gt;authrealm </span>
      ... <span class="comment">// process request and produce response</span>
      <span class="keywordflow">return</span> SOAP_OK;
    }
  }
  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (soap-&gt;authrealm &amp;&amp; soap-&gt;userid) <span class="comment">// Digest authentication</span>
  {
    <a class="code" href="structhttp__da__info.html#aefb8c737836359bb2983f5f88fd52adf">passwd</a> = ... <span class="comment">// database lookup on userid and authrealm to find passwd</span>
    <span class="keywordflow">if</span> (!strcmp(soap-&gt;authrealm, <a class="code" href="structhttp__da__info.html#a6a2f59964d40689e21165afe21a5bf17">authrealm</a>) &amp;&amp; !strcmp(soap-&gt;userid, <a class="code" href="structhttp__da__info.html#a9d713755e3c8a2f2e1754753629f7b51">userid</a>))
    { 
      <span class="keywordflow">if</span> (!<a class="code" href="httpda_8h.html#a4ae547984e266ed9d9f90f79aac1ec66">http_da_verify_post</a>(soap, <a class="code" href="structhttp__da__info.html#aefb8c737836359bb2983f5f88fd52adf">passwd</a>)) <span class="comment">// HTTP POST DA verification</span>
      {
        ... <span class="comment">// process request and produce response</span>
        <span class="keywordflow">return</span> SOAP_OK;
      }
    }
  }
  soap-&gt;authrealm = <a class="code" href="structhttp__da__info.html#a6a2f59964d40689e21165afe21a5bf17">authrealm</a>; <span class="comment">// realm to send to client</span>
  <span class="keywordflow">return</span> 401; <span class="comment">// Not authorized, challenge with digest authentication</span>
}
</pre></div><h2><a class="anchor" id="httpda_5"></a>
HTTP Digest Authentication Limitations</h2>
<p>HTTP Digest Authentication cannot be used with streaming MTOM/MIME/DIME attachments. Streaming is turned off by the plugin and attachment data is buffered rather than streamed. Non-streaming MTOM/MIME/DIME attachments are handled just fine. </p>
</div></div>
<hr class="footer"/><address class="footer"><small>Generated on Tue Sep 27 2011 08:11:09 for gSOAP HTTP Digest Authentication by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
